<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة السائق - Hanwsallak</title>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- Dashboard Styles -->
  <link rel="stylesheet" href="../style/dashboard.css">
  
  <style>
    /* Additional driver-specific styles */
    .trip-card {
      background: linear-gradient(135deg, #ffffff, #f0f7f4);
      border: 2px solid var(--green-light);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    
    .trip-card:hover {
      border-color: var(--green);
      box-shadow: var(--shadow);
    }
    
    .trip-route {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .trip-route i {
      color: var(--green);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--green-light);
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header"></div>
  <script>
    fetch('../components/header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('header').innerHTML = data;
        // Re-execute scripts - wait a bit for DOM to be ready
        setTimeout(() => {
          const scripts = document.getElementById('header').querySelectorAll('script');
          scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            Array.from(oldScript.attributes).forEach(attr => {
              newScript.setAttribute(attr.name, attr.value);
            });
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
          });
        }, 100);
      })
      .catch(err => console.error('خطأ في تحميل الهيدر:', err));
  </script>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="dashboard-brand">
        <div class="dashboard-logo">
          <i class="fa-solid fa-truck"></i>
        </div>
        <div class="dashboard-title">
          <h1>لوحة السائق</h1>
          <div class="subtitle">مرحباً بك، <span id="driverName">السائق</span></div>
        </div>
      </div>
      <div class="dashboard-actions">
        <div style="text-align: right; margin-left: 16px;">
          <div style="font-weight: 700; color: var(--green);" id="driverBalance">الرصيد: EGP 0.00</div>
          <div style="font-size: 0.85rem; color: var(--muted);">التقييم: <span id="driverRating">N/A</span></div>
        </div>
        <button class="btn btn-danger btn-sm" id="logoutBtn">
          <i class="fa-solid fa-sign-out-alt"></i> خروج
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">أرباح اليوم</div>
        <div class="stat-value" id="todayEarnings">EGP 0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">إجمالي الأرباح</div>
        <div class="stat-value" id="totalEarnings">EGP 0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">الطلبات النشطة</div>
        <div class="stat-value" id="activeOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">المكتملة اليوم</div>
        <div class="stat-value" id="completedToday">0</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="dashboard-grid">
      <!-- Left Column -->
      <div class="left">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">الطلبات والرحلات</h3>
            <div class="tabs" id="tabs">
              <button class="tab active" data-tab="available">
                <i class="fa-solid fa-list"></i> المتاحة
              </button>
              <button class="tab" data-tab="my-orders">
                <i class="fa-solid fa-box"></i> طلباتي
              </button>
              <button class="tab" data-tab="my-trips">
                <i class="fa-solid fa-route"></i> رحلاتي
              </button>
            </div>
          </div>

          <div id="tab-content">
            <!-- Available Orders -->
            <div class="list" data-content="available"></div>

            <!-- My Orders -->
            <div class="list" data-content="my-orders" style="display:none"></div>

            <!-- My Trips -->
            <div class="list" data-content="my-trips" style="display:none"></div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <aside class="right">
        <!-- Profile Card -->
        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-avatar" id="avatar">س</div>
            <div class="profile-info">
              <h3 id="profileName">السائق</h3>
              <p id="profileVehicle">مركبة: -</p>
            </div>
          </div>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <div class="badge badge-success">
              <i class="fa-solid fa-weight"></i> الحمولة: <strong id="maxLoad">0</strong> kg
            </div>
            <div class="badge badge-success">
              <i class="fa-solid fa-box"></i> العبوات: <strong id="maxPackages">0</strong>
            </div>
          </div>
        </div>

        <!-- My Trips Sidebar -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">رحلاتي</h3>
          </div>
          <div id="tripsList">
            <!-- Trips will be loaded here -->
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">إجراءات سريعة</h3>
          </div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-primary" id="createTripBtn">
              <i class="fa-solid fa-plus"></i> إنشاء رحلة جديدة
            </button>
            <button class="btn btn-outline" id="refreshBtn">
              <i class="fa-solid fa-refresh"></i> تحديث البيانات
            </button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">تفاصيل الطلب</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div id="modalBody"></div>
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button class="btn btn-outline" id="modalCancel">إغلاق</button>
        <button class="btn btn-primary" id="modalPrimary">قبول الطلب</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script src="../scripts/api.js"></script>
  <script src="../scripts/i18n.js"></script>
  <script>
    // Check authentication
    if (!getAuthToken()) {
      window.location.href = '../login.html';
    }

    // Load user info
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    if (userInfo.fullName) {
      document.getElementById('driverName').textContent = userInfo.fullName;
      document.getElementById('profileName').textContent = userInfo.fullName;
      document.getElementById('avatar').textContent = userInfo.fullName.charAt(0);
    }

    // Data
    const driver = {
      id: userInfo.id || 'd1',
      name: userInfo.fullName || 'السائق',
      rating: 4.7,
      balance: 0,
      vehicle: {
        type: 'Van',
        plateNumber: 'ABC-123',
        maxLoadWeight: 1200,
        maxPackages: 20
      }
    };

    let availableOrders = [];
    let myOrders = [];
    let myTrips = [];

    // Helpers
    function $(sel) { return document.querySelector(sel); }
    function $all(sel) { return Array.from(document.querySelectorAll(sel)); }

    function formatDate(d) {
      if (!d) return '-';
      const dt = new Date(d);
      return dt.toLocaleDateString('ar-EG');
    }

    function showToast(text, type = 'success') {
      const t = $('#toast');
      t.textContent = text;
      t.className = `toast ${type} show`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Render functions
    function renderProfile() {
      $('#driverName').textContent = driver.name;
      $('#profileName').textContent = driver.name;
      $('#avatar').textContent = driver.name.charAt(0) || 'س';
      $('#driverBalance').textContent = `الرصيد: EGP ${driver.balance.toFixed(2)}`;
      $('#driverRating').textContent = driver.rating ? driver.rating.toFixed(1) : 'N/A';
      $('#maxLoad').textContent = driver.vehicle.maxLoadWeight;
      $('#maxPackages').textContent = driver.vehicle.maxPackages;
      $('#profileVehicle').textContent = `مركبة: ${driver.vehicle.type} - ${driver.vehicle.plateNumber}`;
    }

    function calcEarnings() {
      const delivered = myOrders.filter(o => o.status === 'delivered');
      const total = delivered.reduce((s, o) => s + (o.price * 0.7), 0);
      const today = delivered.filter(o => {
        if (!o.deliveredAt) return false;
        const a = new Date(o.deliveredAt);
        const now = new Date();
        return a.toDateString() === now.toDateString();
      }).reduce((s, o) => s + (o.price * 0.7), 0);

      $('#totalEarnings').textContent = `EGP ${total.toFixed(2)}`;
      $('#todayEarnings').textContent = `EGP ${today.toFixed(2)}`;
      $('#activeOrders').textContent = myOrders.filter(o => ['accepted', 'in-transit'].includes(o.status)).length;
      $('#completedToday').textContent = myOrders.filter(o => o.status === 'delivered' && o.deliveredAt && new Date(o.deliveredAt).toDateString() === new Date().toDateString()).length;
    }

    function renderAvailable() {
      const root = document.querySelector('[data-content="available"]');
      root.innerHTML = '';
      if (availableOrders.length === 0) {
        root.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <div>لا توجد طلبات متاحة حالياً</div>
          </div>
        `;
        return;
      }
      availableOrders.forEach(order => {
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
          <div class="item-row">
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--green);">طلب #${order.id}</div>
              <div class="item-label">${formatDate(order.scheduledDate)}</div>
            </div>
            <div style="text-align: left;">
              <div class="price">+EGP ${(order.price * 0.7).toFixed(2)}</div>
              <div class="item-label">أرباحك</div>
            </div>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--green-light);">
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-map-marker-alt"></i> الاستلام:</div>
              <div class="item-value">${order.pickupLocation}</div>
            </div>
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-map-marker-alt"></i> التسليم:</div>
              <div class="item-value">${order.deliveryLocation}</div>
            </div>
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-weight"></i> الوزن:</div>
              <div class="item-value">${order.packageWeight} kg</div>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
            <div class="badges">
              ${order.insurance ? '<span class="badge badge-success"><i class="fa-solid fa-shield"></i> مؤمن</span>' : ''}
              ${order.fragile ? '<span class="badge badge-warning"><i class="fa-solid fa-exclamation-triangle"></i> هش</span>' : ''}
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-outline btn-sm" data-id="${order.id}" data-action="view">
                <i class="fa-solid fa-eye"></i> عرض
              </button>
              <button class="btn btn-primary btn-sm" data-id="${order.id}" data-action="accept">
                <i class="fa-solid fa-check"></i> قبول
              </button>
            </div>
          </div>
        `;
        root.appendChild(el);
      });
    }

    function renderMyOrders() {
      const root = document.querySelector('[data-content="my-orders"]');
      root.innerHTML = '';
      if (myOrders.length === 0) {
        root.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-box-open"></i>
            <div>لم تقبل أي طلبات بعد</div>
          </div>
        `;
        return;
      }
      myOrders.forEach(order => {
        const statusBadge = {
          'accepted': '<span class="badge badge-success">مقبول</span>',
          'in-transit': '<span class="badge badge-warning">قيد التوصيل</span>',
          'delivered': '<span class="badge badge-success">تم التسليم</span>'
        }[order.status] || '';
        
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
          <div class="item-row">
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--green);">طلب #${order.id}</div>
              <div class="item-label">${formatDate(order.scheduledDate)}</div>
            </div>
            <div style="text-align: left;">
              <div class="price">+EGP ${(order.price * 0.7).toFixed(2)}</div>
              <div class="item-label">${order.packageWeight} kg</div>
            </div>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--green-light);">
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-map-marker-alt"></i> من:</div>
              <div class="item-value">${order.pickupLocation}</div>
            </div>
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-map-marker-alt"></i> إلى:</div>
              <div class="item-value">${order.deliveryLocation}</div>
            </div>
            <div class="item-row">
              <div class="item-label"><i class="fa-solid fa-user"></i> العميل:</div>
              <div class="item-value">${order.customerName}</div>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
            ${statusBadge}
            <div style="display: flex; gap: 8px;">
              ${order.status === 'accepted' ? `<button class="btn btn-primary btn-sm" data-id="${order.id}" data-action="start"><i class="fa-solid fa-play"></i> بدء التوصيل</button>` : ''}
              ${order.status === 'in-transit' ? `<button class="btn btn-primary btn-sm" data-id="${order.id}" data-action="mark-delivered"><i class="fa-solid fa-check-circle"></i> تم التسليم</button>` : ''}
            </div>
          </div>
        `;
        root.appendChild(el);
      });
    }

    function renderTrips() {
      const root = $('#tripsList');
      root.innerHTML = '';
      if (myTrips.length === 0) {
        root.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-route"></i>
            <div>لا توجد رحلات حالياً</div>
          </div>
        `;
        return;
      }
      myTrips.forEach(trip => {
        const el = document.createElement('div');
        el.className = 'trip-card';
        el.innerHTML = `
          <div class="trip-route">
            <i class="fa-solid fa-map-marker-alt"></i>
            <div>
              <div style="font-weight: 700;">${trip.from} → ${trip.to}</div>
              <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">
                ${formatDate(trip.departureDate)} • ${trip.departureTime}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <span class="badge badge-success">الحمولة: ${trip.availableCapacity} kg</span>
            <span class="badge badge-success">العبوات: ${trip.maxPackages}</span>
          </div>
        `;
        root.appendChild(el);
      });
    }

    // Modal functions
    function openModal(title, bodyHTML, primaryLabel = 'قبول الطلب', primaryHandler = null) {
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = bodyHTML || '';
      $('#modalPrimary').textContent = primaryLabel;
      $('#modalBackdrop').classList.add('show');
      $('#modalPrimary').onclick = () => {
        if (typeof primaryHandler === 'function') primaryHandler();
        closeModal();
      };
      $('#modalCancel').onclick = closeModal;
      $('#modalClose').onclick = closeModal;
    }

    function closeModal() {
      $('#modalBackdrop').classList.remove('show');
    }

    // API Functions
    async function acceptOrder(orderId) {
      try {
        const order = availableOrders.find(o => o.id === orderId);
        if (!order) { showToast('الطلب غير موجود', 'error'); return; }
        
        await OrderAPI.create({
          tripId: order.tripId,
          shipmentId: order.shipmentId
        });
        
        await OrderAPI.accept(orderId);
        showToast('تم قبول الطلب بنجاح');
        await loadData();
      } catch (error) {
        console.error('Error accepting order:', error);
        showToast('خطأ في قبول الطلب', 'error');
      }
    }

    async function startDelivery(orderId) {
      try {
        await OrderAPI.startDelivery(orderId);
        showToast('تم بدء التوصيل');
        await loadData();
      } catch (error) {
        console.error('Error starting delivery:', error);
        showToast('خطأ في بدء التوصيل', 'error');
      }
    }

    async function markDelivered(orderId) {
      try {
        await OrderAPI.markDelivered(orderId);
        const order = myOrders.find(x => x.id === orderId);
        if (order) {
          driver.balance += order.price * 0.7;
          renderProfile();
        }
        showToast('تم تسليم الطلب. تم تحديث الرصيد');
        await loadData();
      } catch (error) {
        console.error('Error marking delivered:', error);
        showToast('خطأ في تسجيل التسليم', 'error');
      }
    }

    function viewOrder(orderId) {
      const all = [...availableOrders, ...myOrders];
      const o = all.find(x => x.id === orderId);
      if (!o) { showToast('الطلب غير موجود', 'error'); return; }
      const body = `
        <div class="form-group">
          <div class="form-label"><strong>رقم الطلب:</strong> ${o.id}</div>
        </div>
        <div class="form-group">
          <div class="form-label"><i class="fa-solid fa-map-marker-alt"></i> <strong>نقطة الاستلام:</strong></div>
          <div>${o.pickupLocation}</div>
        </div>
        <div class="form-group">
          <div class="form-label"><i class="fa-solid fa-map-marker-alt"></i> <strong>نقطة التسليم:</strong></div>
          <div>${o.deliveryLocation}</div>
        </div>
        <div class="form-group">
          <div class="form-label"><i class="fa-solid fa-weight"></i> <strong>الوزن:</strong> ${o.packageWeight} kg</div>
        </div>
        <div class="form-group">
          <div class="form-label"><strong>الوصف:</strong></div>
          <div>${o.packageDescription || '-'}</div>
        </div>
        <div class="form-group">
          <div class="price" style="font-size: 1.3rem;"><strong>أرباحك:</strong> EGP ${(o.price * 0.7).toFixed(2)}</div>
        </div>
      `;
      openModal(`تفاصيل الطلب #${o.id}`, body, o.status === 'pending' ? 'قبول الطلب' : 'إغلاق', () => {
        if (o.status === 'pending') acceptOrder(o.id);
      });
    }

    async function createTrip() {
      // Simple prompt for now - can be enhanced with a modal
      const fromCity = prompt('من أي مدينة؟', 'Cairo');
      const toCity = prompt('إلى أي مدينة؟', 'Alexandria');
      if (!fromCity || !toCity) return;
      
      try {
        const tripData = {
          fromCity: fromCity,
          toCity: toCity,
          departureDate: new Date(Date.now() + 3 * 86400000).toISOString().split('T')[0],
          departureTime: '07:00:00',
          recurringDay: null,
          availableCapacity: 800,
          maxPackages: 20
        };
        
        await TripAPI.create(tripData);
        showToast('تم إنشاء رحلة جديدة بنجاح');
        await loadData();
      } catch (error) {
        console.error('Error creating trip:', error);
        showToast('خطأ في إنشاء الرحلة', 'error');
      }
    }

    async function loadData() {
      try {
        // Load trips
        const trips = await TripAPI.getMyTrips();
        myTrips = trips.map(t => ({
          id: t.id,
          from: t.fromCity,
          to: t.toCity,
          departureDate: new Date(t.departureDate),
          departureTime: t.departureTime,
          availableCapacity: t.availableCapacity,
          maxPackages: t.maxPackages,
          status: t.status.toLowerCase()
        }));

        // Load available shipments for trips
        availableOrders = [];
        for (const trip of myTrips.filter(t => t.status === 'available')) {
          try {
            const shipments = await MatchingAPI.getShipmentsForTrip(trip.id);
            shipments.forEach(s => {
              availableOrders.push({
                id: s.id,
                scheduledDate: trip.departureDate,
                pickupLocation: s.fromCity,
                deliveryLocation: s.toCity,
                packageWeight: s.weight,
                packageDescription: s.description,
                customerName: s.customerName || 'عميل',
                price: s.offeredPrice,
                status: 'pending',
                shipmentId: s.id,
                tripId: trip.id
              });
            });
          } catch (e) {
            console.error('Error loading shipments for trip:', e);
          }
        }

        // Load my orders
        const orders = await OrderAPI.getMyOrders();
        myOrders = orders.map(o => ({
          id: o.id,
          scheduledDate: new Date(o.trip.departureDate),
          pickupLocation: o.shipment.fromCity,
          deliveryLocation: o.shipment.toCity,
          packageWeight: o.shipment.weight,
          packageDescription: o.shipment.description,
          customerName: o.shipment.customerName || 'عميل',
          price: o.shipment.offeredPrice,
          status: o.status.toLowerCase(),
          deliveredAt: o.deliveredAt ? new Date(o.deliveredAt) : null
        }));

        rerender();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('خطأ في تحميل البيانات', 'error');
      }
    }

    function rerender() {
      renderAvailable();
      renderMyOrders();
      renderTrips();
      calcEarnings();
    }

    // Event Listeners
    document.addEventListener('click', (e) => {
      const t = e.target.closest('button');
      if (!t) return;

      // Tabs
      if (t.matches('.tab')) {
        $all('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        $all('[data-content]').forEach(c => {
          c.style.display = c.dataset.content === tab ? 'flex' : 'none';
        });
      }

      // Action buttons
      if (t.matches('button[data-action]')) {
        const id = t.dataset.id;
        const action = t.dataset.action;
        if (action === 'accept') acceptOrder(id);
        else if (action === 'view') viewOrder(id);
        else if (action === 'start') startDelivery(id);
        else if (action === 'mark-delivered') markDelivered(id);
      }

      if (t.id === 'createTripBtn') createTrip();
      if (t.id === 'refreshBtn') { loadData(); showToast('تم التحديث'); }
      if (t.id === 'logoutBtn') {
        if (typeof removeAuthToken === 'function') {
          removeAuthToken();
        } else {
          localStorage.removeItem('authToken');
          localStorage.removeItem('refreshToken');
          localStorage.removeItem('userInfo');
        }
        window.location.href = '../index.html';
      }
    });

    // Modal backdrop click
    $('#modalBackdrop').addEventListener('click', (ev) => {
      if (ev.target === $('#modalBackdrop')) closeModal();
    });

    // Initialize
    async function init() {
      renderProfile();
      await loadData();
    }
    init();
  </script>
</body>
</html>

</html>
